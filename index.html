<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>لوحة مبيعات الموظفين</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#fff8f0;--ink:#243b53;--muted:#90a4ae;--card:#fff;--edge:#f1f5f9;--brand:#e67e22}
    *{box-sizing:border-box}
    body{font-family:Tajawal,system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--ink); margin:0; padding:24px;}
    h1{margin:0 0 12px;color:var(--brand)}
    .controls{display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px}
    select,input,button{padding:8px 10px;border:1px solid #e1e8ed;border-radius:8px;background:#fff}
    button{background:var(--brand);color:#fff;border-color:var(--brand);cursor:pointer}
    button:hover{opacity:.95}
    .kpis{display:flex; gap:16px; margin:12px 0 16px; flex-wrap:wrap}
    .card{background:var(--card); padding:12px 16px; border-radius:12px; box-shadow:0 1px 4px rgba(0,0,0,.07); min-width:160px}
    .muted{color:var(--muted); font-size:12px}
    .kpi-val{font-weight:700;font-size:20px}
    table{width:100%; border-collapse:collapse; background:#fff; border-radius:12px; overflow:hidden; box-shadow:0 1px 4px rgba(0,0,0,.07)}
    th,td{padding:10px 12px; border-bottom:1px solid var(--edge); font-size:14px; text-align:right}
    th{background:#fff3e6}
    tr:hover{background:#fffdf8}
    canvas{max-width:100%;}
  </style>
</head>
<body>
  <h1>لوحة مبيعات الموظفين</h1>

  <div class="controls">
    <label>المعرض:
      <select id="outlet"></select>
    </label>
    <label>من:
      <input type="date" id="from">
    </label>
    <label>إلى:
      <input type="date" id="to">
    </label>
    <button id="apply">تطبيق الفلتر</button>
  </div>

  <div class="kpis">
    <div class="card"><div class="muted">إجمالي المبيعات</div><div id="kpiNet" class="kpi-val">-</div></div>
    <div class="card"><div class="muted">عدد الفواتير</div><div id="kpiBills" class="kpi-val">-</div></div>
    <div class="card"><div class="muted">متوسط الفاتورة</div><div id="kpiAvg" class="kpi-val">-</div></div>
  </div>

  <table id="tbl">
    <thead>
      <tr>
        <th>الموظف</th>
        <th>المبيعات الصافية</th>
        <th>عدد الفواتير</th>
        <th>عدد فواتير قطعة واحدة</th>
        <th>٪ فواتير قطعة واحدة</th>
        <th>مساهمة الموظف ٪</th>
        <th>التارجت</th>
        <th>٪ تحقيق التارجت</th>
        <th>المتبقي للتارجت</th>
        <th>اليومي المتبقي</th>
        <th>متوسط الفاتورة</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h3 style="margin-top:18px">المبيعات اليومية</h3>
  <canvas id="line"></canvas>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // تنسيقات أرقام
    const fmt  = n => (+n||0).toLocaleString('en-US', {maximumFractionDigits:0});

    let facts=[], outlets=[], staff=[], staffMap={};
    let chart;

    async function loadData() {
      // تحميل ملفات الـETL
      [facts, outlets, staff] = await Promise.all([
        fetch('./dashboard_data/facts.json').then(r=>r.json()),
        fetch('./dashboard_data/outlets.json').then(r=>r.json()),
        fetch('./dashboard_data/staff.json').then(r=>r.json()),
      ]);

      // خريطة الموظف -> الاسم والتارجت
      staffMap = {};
      staff.forEach(s => { staffMap[s.staff_id] = s; });

      // تعبئة قائمة المعارض
      const sel = document.getElementById('outlet');
      sel.innerHTML = '<option value="">كل المعارض</option>';
      outlets.forEach(o=>{
        const opt = document.createElement('option');
        opt.value = o.outlet_name; opt.textContent = o.outlet_name;
        sel.appendChild(opt);
      });

      // نطاق التواريخ الافتراضي
      const dates = facts.map(f=>f.bill_date).sort();
      document.getElementById('from').value = dates[0] || '';
      document.getElementById('to').value   = dates[dates.length-1] || '';

      render();
    }

    function filterData() {
      const outlet = document.getElementById('outlet').value;
      const from = document.getElementById('from').value;
      const to   = document.getElementById('to').value;
      return facts.filter(f =>
        (!outlet || f.outlet_name===outlet) &&
        (!from || f.bill_date >= from) &&
        (!to   || f.bill_date <= to)
      );
    }

    // الأيام المتبقية حتى تاريخ "إلى" (شاملاً اليوم)
    function daysRemainingWithinRange() {
      const toStr = document.getElementById('to').value;
      if(!toStr) return 0;
      const today = new Date(); today.setHours(0,0,0,0);
      const to = new Date(toStr+'T00:00:00');
      if(today > to) return 0;
      const ms = to - today;
      return Math.floor(ms/86400000) + 1;
    }

    function render() {
      const f = filterData();

      // إجمالي مبيعات المعرض للفترة (للمساهمة %)
      const outletTotal = f.reduce((s,r)=>s + (+r.net_amount||0), 0);

      // تجميع حسب الموظف
      const byStaff = {};
      f.forEach(r=>{
        const id   = r.staff_id;
        const name = r.staff_name || (staffMap[id]?.staff_name || 'Unknown');
        if(!byStaff[id]) byStaff[id] = {name, net:0, bills:0, oneBills:0};
        byStaff[id].net      += +r.net_amount || 0;
        byStaff[id].bills    += +r.bills || 0;
        byStaff[id].oneBills += +r.one_item_bills || 0; // يأتي من الـETL
      });

      // بناء صفوف الجدول
      const dRem = daysRemainingWithinRange();
      const rows = Object.entries(byStaff).map(([id,v])=>{
        const target  = +(staffMap[id]?.target_amount || 0);
        const achPct  = target>0 ? (v.net/target*100) : 0;
        const remain  = Math.max(target - v.net, 0);
        const daily   = dRem>0 ? (remain/dRem) : 0;
        const contrib = outletTotal>0 ? (v.net/outletTotal*100) : 0;
        const onePct  = v.bills>0 ? (v.oneBills/v.bills*100) : 0;
        const avg     = v.bills ? (v.net/v.bills) : 0;
        return {
          id,
          name: v.name,
          net: v.net,
          bills: v.bills,
          oneBills: v.oneBills,
          onePct,
          contribPct: contrib,
          target,
          achPct,
          remain,
          daily,
          avg
        };
      }).sort((a,b)=>b.net-a.net);

      // KPIs أعلى الصفحة
      const totNet   = rows.reduce((s,x)=>s+x.net,0);
      const totBills = rows.reduce((s,x)=>s+x.bills,0);
      document.getElementById('kpiNet').textContent  = fmt(totNet);
      document.getElementById('kpiBills').textContent= fmt(totBills);
      document.getElementById('kpiAvg').textContent  = fmt(totBills? totNet/totBills:0);

      // بناء الجدول
      const tb = document.querySelector('#tbl tbody');
      tb.innerHTML = '';
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.name}</td>
          <td>${fmt(r.net)}</td>
          <td>${fmt(r.bills)}</td>
          <td>${fmt(r.oneBills)}</td>
          <td>${r.onePct.toFixed(1)}%</td>
          <td>${r.contribPct.toFixed(1)}%</td>
          <td>${fmt(r.target)}</td>
          <td>${r.achPct.toFixed(1)}%</td>
          <td class="${r.remain>0?'neg':''}">${fmt(r.remain)}</td>
          <td>${fmt(r.daily)}</td>
          <td>${fmt(r.avg)}</td>
        `;
        tb.appendChild(tr);
      });

      // خط المبيعات اليومية
      const byDate = {};
      f.forEach(r=>{ byDate[r.bill_date] = (byDate[r.bill_date]||0) + (+r.net_amount||0); });
      const labels = Object.keys(byDate).sort();
      const data   = labels.map(d=>byDate[d]);

      if(chart) chart.destroy();
      chart = new Chart(document.getElementById('line').getContext('2d'), {
        type: 'line',
        data: { labels, datasets:[{ label:'Net Sales', data }] },
        options: { responsive:true }
      });
    }

    document.getElementById('apply').addEventListener('click', render);
    loadData();
  </script>
</body>
</html>
