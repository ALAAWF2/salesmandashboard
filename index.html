<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>لوحة مبيعات الموظفين</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#fff8f0;--ink:#243b53;--muted:#90a4ae;--card:#fff;--edge:#f1f5f9;--brand:#e67e22}
    *{box-sizing:border-box}
    body{font-family:Tajawal,system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--ink); margin:0; padding:24px;}
    h1{margin:0 0 12px;color:var(--brand)}
    .controls{display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px; align-items:center}
    select,input,button{padding:8px 10px;border:1px solid #e1e8ed;border-radius:8px;background:#fff}
    button{background:var(--brand);color:#fff;border-color:var(--brand);cursor:pointer}
    button:hover{opacity:.95}
    .kpis{display:flex; gap:16px; margin:12px 0 16px; flex-wrap:wrap}
    .card{background:var(--card); padding:12px 16px; border-radius:12px; box-shadow:0 1px 4px rgba(0,0,0,.07); min-width:160px}
    .muted{color:var(--muted); font-size:12px}
    .kpi-val{font-weight:700;font-size:20px}
    table{width:100%; border-collapse:collapse; background:#fff; border-radius:12px; overflow:hidden; box-shadow:0 1px 4px rgba(0,0,0,.07)}
    th,td{padding:10px 12px; border-bottom:1px solid var(--edge); font-size:14px; text-align:right}
    th{background:#fff3e6}
    tr:hover{background:#fffdf8}
    .neg{color:#c62828; font-weight:700}
    label.chk{display:inline-flex; gap:6px; align-items:center; user-select:none}
  </style>
</head>
<body>
  <h1>لوحة مبيعات الموظفين</h1>

  <div class="controls">
    <label>مدير المنطقة:
      <select id="manager"></select>
    </label>
    <label>المعرض:
      <select id="outlet"></select>
    </label>
    <label>من:
      <input type="date" id="from">
    </label>
    <label>إلى:
      <input type="date" id="to">
    </label>
    <label class="chk">
      <input type="checkbox" id="onlyCurrent" checked>
      إظهار موظفي المعرض الحالي فقط
    </label>
    <button id="apply">تطبيق الفلتر</button>
  </div>

  <div class="kpis">
    <div class="card"><div class="muted">إجمالي المبيعات</div><div id="kpiNet" class="kpi-val">-</div></div>
    <div class="card"><div class="muted">عدد الفواتير</div><div id="kpiBills" class="kpi-val">-</div></div>
    <div class="card"><div class="muted">متوسط الفاتورة</div><div id="kpiAvg" class="kpi-val">-</div></div>
  </div>

  <table id="tbl">
    <thead>
      <tr>
        <th>الموظف</th>
        <th>المبيعات الصافية</th>
        <th>عدد الفواتير</th>
        <th>عدد فواتير قطعة واحدة</th>
        <th>٪ فواتير قطعة واحدة</th>
        <th>مساهمة الموظف ٪</th>
        <th>التارجت</th>
        <th>٪ تحقيق التارجت (شهري)</th>
        <th>المتبقي للتارجت (شهري)</th>
        <th>اليومي المتبقي (حتى نهاية الشهر)</th>
        <th>متوسط الفاتورة</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    // ---------- خريطة مدراء المناطق → المعارض ----------
    const managerOutlets = {
      "المنطقة الغربية": [
        "06-Red Sea Mall","13-Al-Yasmin Mall","54-THE VILLAGE"
      ],
      "اماني عسيري": [
        "21-Abha Al_Rashid Mall New","43-Mujan Park","52-Al_Baha Mall","41-Khamis Avenue"
      ],
      "جهاد ايوبي": [
        "16-Ehsa Othaim Mall","27-Dhahran Mall khobar","28-Al Nakheel Mall Dammam","36-Al jubail Mall","42-Dareen Mall Dammam","49-AlAhsa Mall"
      ],
      "خليل الصانع": [
        "17-Arar Othaim Mall","22-Tabuk Park","23-Alia Mall Madinah","24-Yanbu Dana Mall","26-Al-Noor Mall Madinah","44-Al-Jouf Center"
      ],
      "رضوان عطيوي": [
        "08-Makkah Mall","20-Sitten Street Makkah","55- Jabl Omar"
      ],
      "شريفة العمري": [
        "05-Haifa Mall","07-Arab Mall","56- Aziz Mall 2","48 - Jeddah Park"
      ],
      "عبد الجليل الحبال": [
        "15-Riyadh Othaim Mall","25-Rabwa Othaim Mall","39-Salam Mall Riyadh","50-Meem Plaza Riyadh"
      ],
      "عبدالله السرداح": [
        "30-Tala Mall Riyadh","40-Hayat Mall Riyad","19-Hail Othaim Mall","47-Al-Nakheel Plaza"
      ],
      "عبيدة السباعي": [
        "04-Andalos Mall","09-Al-Salam Mall","01-Jeddah INT Market","18-Al_Khayyat Center","53-Al Basateen Mall","57-Sauq7"
      ],
      "محمدكلو": [
        "12-Al_Hamra Mall","32-Atyaf Mall Riyadh","38-Al_Riyadh Park","29-Al Nakheel Mall Riyadh","45- Riyadh Gallery Mall","46-Khaleej Mall Riyadh","51-Park Avenue Riyadh"
      ],
      "منطقة الطائف": [
        "11-Jouri Mall","14-Al Kamal Mall"
      ]
    };

    // ---------- أرقام وتواريخ ----------
    const fmt = n => (+n||0).toLocaleString('en-US', {maximumFractionDigits:0});
    let facts=[], outlets=[], staff=[], staffMap={};
    let hist=[], histMap={};

    function parseD(s){ if(!s) return null; return new Date(s+'T00:00:00'); }
    function today0(){ const d=new Date(); d.setHours(0,0,0,0); return d; }
    function monthStartOf(toStr){
      const d = toStr ? new Date(toStr+'T00:00:00') : today0();
      return new Date(d.getFullYear(), d.getMonth(), 1);
    }
    function daysRemainingToMonthEnd(){
      const t = today0();
      const end = new Date(t.getFullYear(), t.getMonth()+1, 0);
      if (t > end) return 0;
      return Math.floor((end - t)/86400000) + 1;
    }

    // ---------- تاريخ الانتساب ----------
    function buildHistMap(){
      histMap = {};
      hist.forEach(r=>{
        const id = r.staff_id;
        if(!histMap[id]) histMap[id]=[];
        histMap[id].push({
          outlet_name: r.outlet_name,
          start: parseD(r.start_date),
          end:   r.end_date ? parseD(r.end_date) : null
        });
      });
    }
    function isInOutletOnDate(staffId, outlet, refDate){
      const arr = histMap[staffId] || [];
      return arr.some(seg=> seg.outlet_name === outlet &&
                            refDate >= seg.start &&
                            (!seg.end || refDate <= seg.end));
    }

    // ---------- تحميل البيانات ----------
    async function loadData() {
      [facts, outlets, staff, hist] = await Promise.all([
        fetch('./dashboard_data/facts.json').then(r=>r.json()),
        fetch('./dashboard_data/outlets.json').then(r=>r.json()),
        fetch('./dashboard_data/staff.json').then(r=>r.json()),
        fetch('./dashboard_data/staff_outlet_history.json').then(r=>r.json()).catch(()=>[])
      ]);

      staffMap = {};
      staff.forEach(s => { staffMap[s.staff_id] = s; });

      buildHistMap();

      // تعبئة مدراء المناطق
      const mgrSel = document.getElementById('manager');
      mgrSel.innerHTML = '<option value="">كل المدراء</option>' +
        Object.keys(managerOutlets).map(m=>`<option>${m}</option>`).join('');

      // تعبئة المعارض (عام)
      fillOutletsForManager('');

      // نطاق تواريخ افتراضي
      const dates = facts.map(f=>f.bill_date).sort();
      document.getElementById('from').value = dates[0] || '';
      document.getElementById('to').value   = dates[dates.length-1] || '';

      // عند تغيير المدير: حدّث قائمة المعارض
      mgrSel.addEventListener('change', () => {
        fillOutletsForManager(mgrSel.value);
      });

      render();
    }

    // يبني قائمة المعارض حسب المدير المختار
    function fillOutletsForManager(managerName){
      const sel = document.getElementById('outlet');
      sel.innerHTML = '';
      const optAll = document.createElement('option');
      optAll.value = '';
      optAll.textContent = 'كل المعارض';
      sel.appendChild(optAll);

      let list = [];
      if(managerName && managerOutlets[managerName]){
        list = managerOutlets[managerName];
      } else {
        // كل المعارض من ملف outlets.json
        list = outlets.map(o=>o.outlet_name);
      }
      list.forEach(name=>{
        const o = document.createElement('option');
        o.value = name; o.textContent = name;
        sel.appendChild(o);
      });
    }

    // نطاق الفلترة المعروض
    function filterData() {
      const outletSel  = document.getElementById('outlet').value;
      const managerSel = document.getElementById('manager').value;
      const from = document.getElementById('from').value;
      const to   = document.getElementById('to').value;

      // قائمة المعارض المسموح بها حسب المدير (إن وجد)
      const allowedByMgr = managerSel ? new Set(managerOutlets[managerSel] || []) : null;

      return facts.filter(f => {
        if (allowedByMgr && !allowedByMgr.has(f.outlet_name)) return false;
        if (outletSel && f.outlet_name !== outletSel) return false;
        if (from && f.bill_date < from) return false;
        if (to && f.bill_date > to) return false;
        return true;
      });
    }

    // فلترة أسماء غير صالحة
    function isBadName(name){
      if(!name) return true;
      const n = String(name).trim();
      if(!n) return true;
      if (/^(unknow(n)?|unkonw)$/i.test(n)) return true;
      if (/^unknown$/i.test(n)) return true; // "Unknown" فقط (بدون رقم)
      return false;
    }

    // ---------- التصيير ----------
    function render() {
      const f = filterData();
      const outletSel  = document.getElementById('outlet').value;
      const managerSel = document.getElementById('manager').value;
      const onlyCurrent = document.getElementById('onlyCurrent').checked;
      const toStr = document.getElementById('to').value;
      const refDate = parseD(toStr) || today0();

      // إجمالي مبيعات الفترة (للمساهمة %)
      const outletTotal = f.reduce((s,r)=>s + (+r.net_amount||0), 0);

      // تجميع حسب الموظف
      const byStaff = {};
      f.forEach(r=>{
        const id   = r.staff_id;
        const name = (r.staff_name || staffMap[id]?.staff_name || '').trim();
        if (isBadName(name)) return;

        if(!byStaff[id]) byStaff[id] = {name, net:0, bills:0, oneBills:0};
        byStaff[id].net      += +r.net_amount || 0;
        byStaff[id].bills    += +r.bills || 0;
        byStaff[id].oneBills += +r.one_item_bills || 0;
      });

      // ---- حساب MTD (من أول الشهر حتى "إلى") مع احترام مدير المنطقة والمعرض المختار ----
      const mStart = monthStartOf(toStr).toISOString().slice(0,10);
      const mEnd   = toStr || (facts.length ? facts.map(x=>x.bill_date).sort().slice(-1)[0] : '');
      const allowedByMgr = managerSel ? new Set(managerOutlets[managerSel] || []) : null;

      const mtd = facts.filter(r => {
        if (allowedByMgr && !allowedByMgr.has(r.outlet_name)) return false;
        if (outletSel && r.outlet_name !== outletSel) return false;
        if (r.bill_date < mStart) return false;
        if (mEnd && r.bill_date > mEnd) return false;
        return true;
      });

      const byStaffMTD = {};
      mtd.forEach(r=>{
        const id   = r.staff_id;
        const name = (r.staff_name || staffMap[id]?.staff_name || '').trim();
        if (isBadName(name)) return;
        if(!byStaffMTD[id]) byStaffMTD[id] = {name, net:0};
        byStaffMTD[id].net += +r.net_amount || 0;
      });

      const dRemMonth = daysRemainingToMonthEnd();
      let rows = Object.entries(byStaff).map(([id,v])=>{
        const target  = +(staffMap[id]?.target_amount || 0);
        const mtdNet  = (byStaffMTD[id]?.net || 0);
        const achPct  = target>0 ? (mtdNet/target*100) : 0;
        const remain  = Math.max(target - mtdNet, 0);
        const daily   = dRemMonth>0 ? (remain/dRemMonth) : 0;
        const contrib = outletTotal>0 ? (v.net/outletTotal*100) : 0;
        const onePct  = v.bills>0 ? (v.oneBills/v.bills*100) : 0;
        const avg     = v.bills ? (v.net/v.bills) : 0;

        return { id, name:v.name, net:v.net, bills:v.bills, oneBills:v.oneBills,
                 onePct, contribPct:contrib, target, achPct, remain, daily, avg };
      });

      // “إظهار موظفي المعرض الحالي فقط” يعمل عند اختيار معرض محدد فقط
      if (onlyCurrent && outletSel) {
        rows = rows.filter(r => isInOutletOnDate(r.id, outletSel, refDate));
      }

      rows.sort((a,b)=>b.net-a.net);

      // KPIs
      const totNet   = rows.reduce((s,x)=>s+x.net,0);
      const totBills = rows.reduce((s,x)=>s+x.bills,0);
      document.getElementById('kpiNet').textContent  = fmt(totNet);
      document.getElementById('kpiBills').textContent= fmt(totBills);
      document.getElementById('kpiAvg').textContent  = fmt(totBills? totNet/totBills:0);

      // جدول
      const tb = document.querySelector('#tbl tbody');
      tb.innerHTML = '';
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.name}</td>
          <td>${fmt(r.net)}</td>
          <td>${fmt(r.bills)}</td>
          <td>${fmt(r.oneBills)}</td>
          <td>${r.onePct.toFixed(1)}%</td>
          <td>${r.contribPct.toFixed(1)}%</td>
          <td>${fmt(r.target)}</td>
          <td>${r.achPct.toFixed(1)}%</td>
          <td class="${r.remain>0?'neg':''}">${fmt(r.remain)}</td>
          <td>${fmt(r.daily)}</td>
          <td>${fmt(r.avg)}</td>
        `;
        tb.appendChild(tr);
      });
    }

    document.getElementById('apply').addEventListener('click', render);
    loadData();
  </script>
</body>
</html>
